
# Отчёт о проекте Seeding



## Введение

**Seeding** – это кроссплатформенное приложение для просмотра и обработки изображений (в том числе PDF-документов) с использованием технологий компьютерного зрения. Проект написан на Python с графическим интерфейсом на библиотеке PyQt5. Главная задача программы – автоматически находить на изображениях сеянцы (маленькие проростки растений) с помощью модели нейросети YOLOv8 и наглядно показывать результаты пользователю. Приложение представляет собой удобный инструмент, позволяющий загружать изображения, запускать детекцию объектов и просматривать найденные сеянцы в структуре слоёв. Все найденные объекты можно детально рассмотреть, поворачивать и масштабировать, а по итогам работы программа умеет формировать PDF-отчёт с отмеченными объектами. Проект создавался как учебный или прикладной инструмент, демонстрирующий, как современные модели компьютерного зрения могут быть интегрированы в простое настольное приложение для облегчения рутинных задач (в данном случае – подсчёта или анализа сеянцев на изображениях).

---

## Назначение и описание системы

Назначение системы **Seeding** – упростить и ускорить процесс обнаружения сеянцев на изображениях. Вручную просматривать фотографии или отсканированные страницы в поисках мелких объектов трудно и долго, поэтому был разработан инструмент, автоматически выполняющий эту работу. Система предназначена для пользователей, которым нужно обработать изображения с проростками (например, биологам или агрономам, анализирующим результаты посева). Программа не только находит объекты, но и предоставляет удобный интерфейс для их изучения и сохранения результатов.

**Основные возможности приложения Seeding:**
- **Загрузка изображений и PDF:** Пользователь может открыть файлы изображений (PNG, JPG, BMP и т.д.) или PDF-документы. Если загружается PDF, все его страницы автоматически конвертируются в изображения для последующей обработки.
- **Отображение в виде слоёв:** Загруженные страницы или изображения отображаются в специальном дереве слоёв – списке, где корневые элементы соответствуют исходным изображениям/страницам, а вложенные элементы будут представлять найденные на них объекты.
- **Автоматическая детекция сеянцев:** Программа по команде запускает модель YOLOv8, обученную искать объекты класса “Seeding” (сеянец), и отмечает их на изображении.
- **Удобный просмотр результатов:** После детекции пользователь видит все найденные объекты в списке и может щёлкнуть на каждый, чтобы увидеть увеличенное изображение вырезанного объекта. Есть функции масштабирования (приближения/отдаления изображения), поворота на 90° и вписывания изображения по размеру окна.
- **Структурированное хранение данных:** Все данные об изображениях и найденных объектах сохраняются внутри программы в специально определённых структурах (на основе Python dataclass).
- **Формирование PDF-отчёта:** По запросу пользователя приложение генерирует отчёт в формате PDF, где на каждой странице представлено исходное изображение с отмеченными на нём объектами, список (таблица) найденных сеянцев с их характеристиками и небольшие изображения каждого объекта.

Таким образом, система Seeding помогает автоматизировать поиск сеянцев и визуализировать результаты понятным образом. Пользователю не нужно иметь глубоких знаний в области нейросетей – достаточно запустить программу, загрузить файл и нажать кнопку для запуска поиска. Все технические детали (работа модели YOLOv8, обработка изображений, компоновка отчёта) выполняются “за кулисами”, предоставляя на выходе готовый наглядный результат.

---

## Архитектура и структура проекта

Проект имеет в основе пакет `seeding`, в котором организованы все модули. Код разделён на логические части, что облегчает поддержку и понимание. Ниже приведена структура файлов и каталогов проекта с кратким описанием каждого важного элемента:

- **seeding/__init__.py:** Пустой файл-инициализатор, обозначающий директорию `seeding` как пакет Python.
- **seeding/main.py:** Главный исполняемый модуль, точка входа приложения. Здесь настраивается запуск PyQt5-приложения: создаётся объект QApplication, применяется тема оформления (используется пакет `qt_material` для тёмной темы), загружается модель YOLOv8 и открывается главное окно программы (`ImageEditor`).
- **seeding/config.py:** Файл конфигурации приложения. Содержит глобальные настройки, такие как путь по умолчанию до весов модели YOLOv8 и параметр поворота изображений.
- **seeding/ui/main_window.py:** Основной модуль интерфейса – здесь определён класс `ImageEditor`, отвечающий за построение окна приложения и обработку основных действий пользователя.
- **seeding/ui/tree_widget.py:** Модуль, определяющий виджет дерева слоёв (`LayerTreeWidget`), для отображения иерархии: страницы/изображения (корневые узлы) и найденные объекты на них (дочерние узлы).
- **seeding/utils.py:** Модуль вспомогательных функций. Здесь находится, в частности, функция `simple_nms` – простая реализация алгоритма Non-Maximum Suppression для фильтрации перекрывающихся боксов после работы модели.
- **seeding/models/data_models.py:** Модуль с определениями структур данных (`dataclass`) для хранения информации об изображениях и найденных объектах.
- **seeding/processing/image_processor.py:** Заглушка для алгоритмов обработки изображений. В текущей версии проекта этот модуль фактически пустой или содержит минимальный код.
- **seeding/report.py:** Модуль генерации отчёта. Содержит функцию `create_pdf_report`, которая принимает структуру данных с результатами и путь, куда сохранить PDF.
- **seeding/requirements.txt:** Список зависимостей проекта – библиотеки Python, которые необходимо установить для работы программы.

В целом архитектура проекта представляет собой классическое настольное приложение: отделён интерфейс (пакет `ui`), логика обработки (функции в `utils`, алгоритмы в `processing`), хранение данных (`models`) и вспомогательные утилиты. Такая структура упрощает поддержку и доработку.

---

## Зависимости и запуск

Для работы приложения **Seeding** необходим интерпретатор Python версии 3.9 или выше. Перед запуском нужно установить ряд библиотек (зависимостей):

- PyQt5 — для графического интерфейса.
- qt-material — пакет тем оформления для PyQt.
- NumPy — для работы с массивами изображений.
- opencv-python (OpenCV) — для загрузки изображений, преобразований и рисования рамок.
- Pillow (PIL) — для некоторых операций с изображениями и совместимости, например, для генерации отчёта.
- PyMuPDF (fitz) — для чтения PDF-файлов и извлечения страниц как изображений.
- ultralytics — реализует модель YOLOv8, которая используется для детекции объектов.
- reportlab — для генерации PDF-отчётов.

**Установка зависимостей**:

```bash
  pip install -r seeding/requirements.txt
```

**Запуск приложения**:

```bash
  python -m seeding.main --weights results/exp_yolov8_custom_best11/weights/best.pt
```

Если параметр `--weights` не указан при запуске, программа попытается взять путь к весам из переменной окружения `YOLO_WEIGHTS_PATH`. Если не задана и переменная, тогда используется путь по умолчанию, прописанный в `config.py`.

---

## Интерфейс и взаимодействие с пользователем

Графический интерфейс Seeding интуитивно понятен и напоминает простые программы для просмотра изображений, дополненные специальными функциями. После запуска приложения появляется главное окно, которое условно можно разделить на три области:

1. **Верхнее меню:** В меню “Файл” доступен пункт “Открыть файл”, позволяющий выбрать изображение или PDF-документ для загрузки.
2. **Боковая панель инструментов (Toolbar):** Слева расположена вертикальная панель с кнопками-иконками для основных действий:
   - “Создать маску” — пока не реализовано.
   - “Найти сеянцы” — запускает процесс детекции на текущем изображении.
   - “Найти все сеянцы” — пакетная обработка всех страниц/изображений.
   - “Классификация” — пока не реализовано.
   - “Повернуть на 90°” — поворачивает выбранное изображение или объект.
   - “Создать отчёт” — формирует PDF-отчёт с результатами.
   - “Приблизить”, “Отдалить”, “Вписать” — для управления масштабом изображения.
3. **Центральная область и панель слоёв:** Основная часть окна разделена на две области: слева — область просмотра изображения, справа — панель слоёв (`LayerTreeWidget`). В дереве отображаются все загруженные страницы и найденные объекты. Щёлкнув по элементам дерева, пользователь может видеть либо всю страницу с отмеченными рамками, либо конкретный crop найденного сеянца.

В целом взаимодействие выстроено по сценарию: **Открыть файл → Найти сеянцы → Изучить результаты → Сохранить отчёт**.

---

## Обработка изображений и детекция

В основе поиска сеянцев лежит модель YOLOv8, интегрированная через библиотеку Ultralytics.

**Основные этапы обработки:**
- При запуске приложения загружается модель YOLOv8 с указанными весами.
- При нажатии “Найти сеянцы” вызывается модель на текущем изображении.
- Детекция производится только по классу “Seeding”.
- После получения результатов применяется Non-Maximum Suppression (NMS) для удаления дубликатов и пересекающихся объектов.
- Для каждого объекта вырезается crop-фрагмент, при необходимости поворачивается вертикально.
- Результаты сохраняются в структуру ObjectImage и отображаются в дереве слоёв.
- При выборе “Найти все сеянцы” обработка выполняется для всех страниц/изображений.

**Примечание:** Кнопки “Создать маску” и “Классификация” пока не реализованы, но предусмотрены для будущих функций.

---

## Модель хранения данных

Для удобства работы с данными используются Python dataclass.

**Основные структуры:**
- `OriginalImage` — хранит информацию о загруженном файле, списки изображений, масок, и списки найденных объектов.
- `ObjectImage` — отдельный обнаруженный объект (сеянец): класс, уверенность, crop, bbox, вложенные подклассы (опционально).
- `AllClassImage` — структура для хранения информации о возможных подклассах внутри объекта (зарезервировано для будущего).

Использование таких структур делает код более прозрачным, а взаимодействие с данными — удобным и безопасным для последующей доработки.

---

## Генерация отчётов

Автоматическая генерация PDF-отчёта реализована через функцию `create_pdf_report` в модуле `report.py`.

**Логика формирования отчёта:**
- Для каждого исходного изображения/страницы формируется отдельный раздел.
- Сначала добавляется исходное изображение с отмеченными рамками и номерами объектов.
- Далее — таблица найденных объектов: номер, класс, уверенность, bbox.
- Затем на отдельных страницах размещаются увеличенные crop-изображения каждого объекта.
- Все изображения автоматически масштабируются и конвертируются для PDF.

Итоговый PDF содержит структурированную информацию и миниатюры всех объектов. Файл сохраняется рядом с исходником с добавлением постфикса `_report.pdf`.

---

## Как работает программа и что делают функции (алгоритм и ключевые функции)

### Основной сценарий работы:

1. **Запуск приложения:**  
   Пользователь запускает команду:
   ```bash
   python -m seeding.main --weights results/exp_yolov8_custom_best11/weights/best.pt
   ```
   Загружается модель YOLOv8, открывается главное окно.

2. **Открытие файла:**  
   Через меню “Открыть файл” загружается изображение или PDF. Все страницы PDF конвертируются в изображения и добавляются в панель слоёв.

3. **Детекция объектов:**  
   Кнопка “Найти сеянцы” запускает поиск объектов на текущем изображении, а “Найти все сеянцы” — на всех загруженных страницах.

4. **Работа с результатами:**  
   Найденные объекты отображаются в дереве слоёв, можно рассматривать crop, увеличивать, поворачивать.

5. **Формирование отчёта:**  
   Кнопка “Создать отчёт” формирует PDF-документ с результатами, который сохраняется автоматически.

6. **Завершение работы:**  
   После формирования отчёта пользователь может закрыть программу. Все временные данные хранятся в оперативной памяти и не создают “мусора” на диске.

---
## Данные и результаты обучения YOLOv8

### Датасет

Для обучения модели YOLOv8 был использован собственный датасет изображений с сеянцами. Точное количество снимков неизвестно, но можно предположить, что всего было примерно 200–300 фото, размеченных вручную: для каждого изображения есть разметка в формате YOLO с координатами боксов и классом объекта. Вся разметка — для одного класса ("сеянец"). Данные разделены на обучающую и валидационную выборки в пропорции 80/20. Все изображения примерно одного типа и размера, что позволило добиться высокой точности обучения.

### Параметры обучения

Основные параметры, с которыми обучалась модель (взято из `args.yaml`):

- **Модель:** YOLOv8n (nano, лёгкая версия)
- **Весы:** предобученные (начинали с yolov8n.pt)
- **Эпох:** 200 (с Early Stopping на patience 100)
- **Размер изображений:** 1024×1024
- **Batch size:** 16
- **Learning rate:** 0.0005, постепенно снижался (cosine schedule)
- **Momentum:** 0.937
- **Weight decay:** 0.0005
- **Аугментации:** случайные повороты, масштаб, сдвиги, цветовые сдвиги (Hue/Sat/Val), случайные вырезки, отключён Mosaic
- **Устройство:** GPU (CUDA), AMP (ускорение через смешанную точность)

Все графики, веса и логи обучения сохранялись в папке `results/exp_yolov8_custom_best11`.

### Основные метрики

Обученная модель показала отличные результаты на валидации:

- **Precision (точность):** ~0.99
- **Recall (полнота):** ~0.99
- **mAP@50:** ~0.995
- **mAP@50-95:** ~0.86

**Графики обучения:**  
Во время тренировки строились и сохранялись графики Precision-Recall (PR curve), F1-score и Loss (ошибка).  
- PR-кривая показывает почти максимальные значения по всем порогам уверенности.
- F1-score быстро вышел на плато и держался близко к 0.99.
- Loss уверенно уменьшался, различий между train и val-loss почти не было — явного переобучения не замечено.

### Итоги и интерпретация

- Модель YOLOv8 отлично научилась находить сеянцы на тренировочном и валидационном датасете: почти 100% объектов распознано.
- Высокие метрики — это хорошо для проекта, но они же могут говорить о небольшом объёме или однотипности данных: есть риск переобучения.
- Для уверенности в качестве работы стоит дополнительно протестировать модель на новых изображениях и, если потребуется, расширить датасет.
- В текущей задаче — для автоматизации поиска сеянцев на стандартных фото — результат более чем удовлетворительный, модель готова к использованию в приложении.

---

> **Вывод:**  
> Обучение модели прошло успешно, итоговые веса (`best.pt`) используются для автоматической детекции в проекте Seeding. При необходимости модель можно быстро дообучить на новых примерах или увеличить разнообразие данных для большей универсальности.

## Заключение
> Проект **Seeding** демонстрирует, как современные методы компьютерного зрения могут быть интегрированы в настольное приложение для решения прикладных задач (например, автоматизации анализа изображений). Благодаря удобному интерфейсу и мощной модели YOLOv8, программа быстро и точно находит объекты, предоставляет наглядный результат и формирует отчёт для последующего использования. Структура кода и архитектура приложения делают его удобным для дальнейшей доработки и расширения функциональности.

